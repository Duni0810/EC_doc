2　PS/2接口硬件

2．1 物理连接器

一般，具有五脚连接器的键盘称之为ＡＴ键盘，而具有六脚mini-DiN连接器的键盘则称之为PS/2键盘。其实这两种连接器都只有四个脚有意义。 它们分别是Clock(时钟脚)、DATA数据脚　、＋5Ｖ(电源脚)和Ｇｒｏｕｎｄ(电源地)。在PS/2键盘与PC机的物理连接上只要保证这四根线 一一对应就可以了。PS/2键盘靠PC的PS/2端口提供＋5Ｖ电源，另外两个脚Clock(时钟脚)和DATA数据脚　都是集电极开路的，所以必须接 大阻值的上拉电阻。它们平时保持高电平，有输出时才被拉到低电平，之后自动上浮到高电平。现在比较常用的连接器如图１所示。

2．2 电气特性

PS/2通讯协议是一种双向同步串行通讯协议。通讯的两端通过Clock(时钟脚)同步，并通过DATA(数据脚)交换数据。任何一方如果想抑制另 外一方通讯时，只需要把Clock(时钟脚)拉到低电平。如果是PC机和PS/2键盘间的通讯，则PC机必须做主机，也就是说，PC机可以抑制PS/2键 盘发送数据，而PS/2键盘则不会抑制PC机发送数据。一般两设备间传输数据的最大时钟频率是３３kHz，大多数PS/2设备工作在10～20kHz。推 荐值在15kHz左右，也就是说，Clock(时钟脚)高、低电平的持续时间都为40μs。每一数据帧包含11～12个位，具体含义如表1所列。

表1 数据帧格式说明

1个起始位 总是逻辑0 
8个数据位 (LSB)低位在前 
1个奇偶校验位 奇校验 
1个停止位 总是逻辑1 
1个应答位 仅用在主机对设备的通讯中 
 

表中，如果数据位中1的个数为偶数，校验位就为1；如果数据位中1的个数为奇数，校验位就为0；总之，数据位中1的个数加上校验位中1的个数总为奇数，因此总进行奇校验。

2．3 PS/2设备和PC机的通讯

PS/2设备的Clock(时钟脚)和DATA数据脚　都是集电极开路的，平时都是高电平。当PS/2设备等待发送数据时，它首先检查Clock (时钟脚)以确认其是否为高电平。如果是低电平，则认为是PC机抑制了通讯，此时它必须缓冲需要发送的数据直到重新获得总线的控制权(一般PS/2键盘有 1６个字节的缓冲区，而PS/2鼠标只有一个缓冲区仅存储最后一个要发送的数据)。如果Clock(时钟脚)为高电平，PS/2设备便开始将数据发送到 PC机。一般都是由PS/2设备产生时钟信号。发送时一般都是按照数据帧格式顺序发送。其中数据位在Clock(时钟脚)为高电平时准备好，在Clock (时钟脚)的下降沿被PC机读入。PS/2设备到PC机的通讯时序如图2所示。



当时钟频率为15kHz时，从Clock(时钟脚)的上升沿到数据位转变时间至少要5μs。数据变化到Clock(时钟脚)下降沿的时间至少也有5 μs，但不能大于25 μs，这是由PS/2通讯协议的时序规定的。如果时钟频率是其它值，参数的内容应稍作调整。

上述讨论中传输的数据是指对特定键盘的编码或者对特定命令的编码。一般采用第二套扫描码集所规定的码值来编码。其中键盘码分为通码(Make)和断 码(Break)。通码是按键接通时所发送的编码，用两位十六进制数来表示，断码通常是按键断开时所发送的编码，用四位十六进制数来表示。

3. PS/2接口的嵌入式软件编程方法

PS/2设备主要用于产生同步时钟信号和读写数据。

3．1 PS/2向PC机发送一个字节

从PS/2向PC机发送一个字节可按照下面的步骤进行：

(1)检测时钟线电平，如果时钟线为低，则延时50μs；

(2)检测判断时钟信号是否为高，为高，则向下执行，为低，则转到(1)；

(3)检测数据线是否为高，如果为高则继续执行，如果为低，则放弃发送(此时PC机在向PS/2设备发送数据，所以PS/2设备要转移到接收程序处接收数据)；

(4)延时20μs(如果此时正在发送起始位，则应延时４0μs)；

(5)输出起始位(0)到数据线上。这里要注意的是：在送出每一位后都要检测时钟线，以确保PC机没有抑制PS/2设备，如果有则中止发送；

(6)输出8个数据位到数据线上；

(7)输出校验位；

(8)输出停止位(1)；

(9)延时30μs(如果在发送停止位时释放时钟信号则应延时50μs)；

通过以下步骤可发送单个位：

(1)准备数据位(将需要发送的数据位放到数据线上)；

(2)延时20μs；

(3)把时钟线拉低；

(4)延时４0μs；

(5)释放时钟线；

(6)延时20μs。

3．2 PS/2设备从PC机接收一个字节

由于PS/2设备能提供串行同步时钟，因此，如果PC机发送数据，则PC机要先把时钟线和数据线置为请求发送的状态。PC机通过下拉时钟线大于 100μs来抑制通讯，并且通过下拉数据线发出请求发送数据的信号，然后释放时钟?盤S/2设备检测到需要接收的数据时，它会产生时钟信号并记录下面8个 数据位和一个停止位。主机此时在时钟线变为低时准备数据到数据线，并在时钟上升沿锁存数据。而PS/2设备则要配合PC机才能读到准确的数据。具体连接步 骤如下：

(1)等待时钟线为高电平。

(2)判断数据线是否为低，为高则错误退出，否则继续执行。

(3)读地址线上的数据内容，共8个bit，每读完一个位，都应检测时钟线是否被PC机拉低，如果被拉低则要中止接收。

(4)读地址线上的校验位内容，1个bit。

(5)读停止位。

(6)如果数据线上为0(即还是低电平)，PS/2设备继续产生时钟，直到接收到1且产生出错信号为止(因为停止位是1，如果PS/2设备没有读到停止位，则表明此次传输出错)。

(7) 输出应答位。

(8) 检测奇偶校验位，如果校验失败，则产生错误信号以表明此次传输出现错误。

(9)延时４5 μs，以便PC机进行下一次传输。

读数据线的步骤如下：

(1)延时20μs；

(2)把时钟线拉低

(3)延时４0μs

(4)释放时钟线

(5)延时20μs

(6)读数据线。

下面的步骤可用于发出应答位；

(1)延时15μs；

(2)把数据线拉低；

(3)延时5μs；

(4)把时钟线拉低；

(5)延时４0μs；

(6)释放时钟线；

(7)延时5μs；

(8)释放数据线。